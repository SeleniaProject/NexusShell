# NexusShell CUI/TUI デザイン仕様書

> **目的**: 本書は NexusShell のユーザインタフェース (CUI/TUI) を世界最高水準に仕上げるためのデザインガイドラインを定義する。起動直後の画面レイアウトから各コマンドの出力フォーマット、テーマ設計、アクセシビリティまで詳細に規定し、実装者が一貫性のある美しい UI を構築できるよう支援する。

---

## 目次
1. デザイン目標  
2. コア UI コンポーネント  
3. 起動シーケンス & スプラッシュ  
4. プロンプト & ステータスライン  
5. コマンド出力フォーマット  
6. カラーテーマ & タイポグラフィ  
7. ビジュアルアクセシビリティ  
8. インタラクションパターン  
9. コンフィギュレーション & カスタマイズ  
10. 実装指針 (ratatui / crossterm)  
11. 付録: モックアップ & ANSI アート  

---

## 1. デザイン目標
| # | 目標 | 指標 |
|---|------|------|
| 1 | **瞬時に美しい** | 起動 5 ms 以内にスプラッシュ表示、16 ms 以内にプロンプト描画完了 |
| 2 | **情報過多の回避** | 同時に表示する情報は 3 レイヤ以内 (メイン、補助、詳細) |
| 3 | **可読性最優先** | コントラスト比 WCAG 2.1 AA 以上、TrueType フォント推奨幅計算 |
| 4 | **一貫した体験** | すべてのコマンドが同一 Table / List / Log コンポーネントを使用 |
| 5 | **高速操作フィードバック** | キーストローク → 画面更新 <= 10 ms |

---

## 2. コア UI コンポーネント
| コンポーネント | 説明 | 主ライブラリ |
|----------------|------|--------------|
| スプラッシュ (Splash) | 起動時にブランドロゴとバージョン・ロード進捗を表示 | `ratatui::widgets::Paragraph` + ANSI アート |
| プロンプト (Prompt) | 入力行 (PS1/PS2) と右寄せミニインフォ | カスタム Widget |
| ステータスライン (Status Bar) | ジョブ数・Git・時刻・CPU/メモリ | `ratatui::widgets::Tabs` |
| 出力ペイン (Output Pane) | コマンド STDOUT/STDERR のスクロールビュー | `ratatui::widgets::Scroll` |
| テーブラー (Tabular) | help/ls 等の表形式表示 | `tui_table` 拡張 |
| トースト (Toast) | 非破壊通知バナー | 非同期レイヤ |
| プログレスバー (Progress) | cp/rsync 等の進行状況 | `indicatif` ラッパ |
| サイドパネル (Sidebar) | オプションペイン・補完一覧 | フローティング Window |

---

## 3. 起動シーケンス & スプラッシュ
1. **0-5 ms**: 端末サイズ取得 → TrueColor 判定。  
2. **5-10 ms**: `nxsh_logo.ans` (ANSI アート) をフェードイン描画。  
3. **10-12 ms**: バージョン (例 `v23.11.07-beta`)、ロード済みプラグイン数、テーマ名を下部に描画。  
4. **12-16 ms**: ステータスライン初期化 → プロンプト描画 → 入力受付開始。

### 3.1 スプラッシュ例
```
███████╗███╗   ██╗██╗  ██╗███████╗███████╗██╗  ██╗
██╔════╝████╗  ██║██║ ██╔╝██╔════╝██╔════╝╚██╗██╔╝  NexusShell v23.11.07
█████╗  ██╔██╗ ██║█████╔╝ █████╗  ███████╗ ╚███╔╝   Theme: Gruvbox-Dark
██╔══╝  ██║╚██╗██║██╔═██╗ ██╔══╝  ╚════██║ ██╔██╗   Plugins: 12 loaded
███████╗██║ ╚████║██║  ██╗███████╗███████║██╔╝ ██╗  © SeleniaProject 2025
╚══════╝╚═╝  ╚═══╝╚═╝  ╚═╝╚══════╝╚══════╝╚═╝  ╚═╝
```
- アートは 80×9 以内、端末幅が狭い場合は自動縮小。

---

## 4. プロンプト & ステータスライン
### 4.1 プロンプト構成
```
λ user@host  ~/workspace  (git:main↓2✗)  ▶
```
| セグメント | 内容 | 色 / スタイル |
|------------|------|---------------|
| λ | 権限 (root ⇒ # 赤) | Bold Cyan |
| user@host | ユーザ名@ホスト名 | Bold Green |
| ~/workspace | カレントディレクトリ | Blue |
| git:main↓2✗ | Git branch / 差分 | Yellow / Red ✓✗ |
| ▶ | 入力開始マーカー | Bold White |

- **右寄せミニインフォ**: HH:MM、バッテリ、CPU%, MEM% を表示 (非互換端末は無効化)。  
- **改行プロンプト**: コマンドが長い場合 2 行表示し下線で連結。

### 4.2 ステータスライン例
```
[Jobs: 1] [CPU 12%] [Mem 1.2G] [Net ↑56K ↓120K] [Load 0.42] [14:32:15]
```
- 100 ms 間隔で非同期更新、STDOUT 流量が多い際は更新間隔自動延長。

---

## 5. コマンド出力フォーマット
### 5.1 汎用テーブル
| 指針 | 内容 |
|------|------|
| 最大幅制御 | 端末幅の 95% に自動フィット、残り 5% スクロールバー |
| カラム幅 | 一行目ヘッダを基準に動的調整、最小幅 8 文字 |
| 行番号 | `--line-num` オプションで左端に灰色表示 |
| 配色 | ヘッダ = Bold White、奇数行 = None、偶数行 = 黒背景 5% 透過 |

### 5.2 ファイルリスト (`ls`)
```
Permissions Size  Modified            Name
rw-r--r--   2.1K  2025-11-07 14:12    Cargo.toml  🦀
-rwxr-xr-x  12.4M 2025-11-05 10:22    nxsh        🔧*
```
- 拡張子アイコン: `🦀` Rust, `📄` テキスト, `📂` ディレクトリ。  
- 実行可ファイルは `*`、Git 未追跡は赤、変更は黄、コミット済は緑。

### 5.3 プログレスバー
```
[██████████────────] 45%  ETA 00:12  12.4 MiB/s
```
- `indicatif` で描画、TrueColor 端末はグラデーション。

### 5.4 エラーメッセージ
```
✘ Error: permission denied: ./secret.pem  (code: EACCES)
```
- 赤背景 / 白文字、左端に `✘`、下にスタックトレース (詳細モード)。

---

## 6. カラーテーマ & タイポグラフィ
| テーマ | ベース | 用途 | コントラスト |
|--------|--------|------|--------------|
| Gruvbox-Dark | #282828 背景 | デフォルト | 7.2:1 |
| Solarized-Light | #fdf6e3 背景 | 日光下 | 4.5:1 |
| Monokai-Pro | #2d2a2e 背景 | 開発者人気 | 6.8:1 |
| High-Contrast | #000 / #FFF | 視覚障害対応 | 15:1 |

- フォントは `FiraCode`, `JetBrainsMono`, 等幅必須。任意リガチャは無効化可能。

---

## 7. ビジュアルアクセシビリティ
1. **色覚サポート**: デフォルトで 8% 色弱シミュレーションをパス。  
2. **TTY ブラインドモード**: `NXSH_TTY_NOCOLOR=1` で色・装飾を除去。  
3. **スクリーンリーダー**: ANSI 制御文字を `OSC 9 ;` メタデータとして埋め込み、読み上げ順序を保持。

---

## 8. インタラクションパターン
| 操作 | 効果 | 備考 |
|------|------|------|
| `Ctrl+R` | インクリメンタル検索 | 検索候補がリアルタイムハイライト |
| `Alt+↑/↓` | 出力ペイン単独スクロール | ジョブ実行中でもスムーズ |
| `Tab` | 補完 | サイドパネルで候補ツリー |
| `Ctrl+G` | Git インフォパネル | branch, diff, stash 一覧 |
| `F1` | ドキュメントポップアップ | cursor 上コマンドの help |

---

## 9. コンフィギュレーション & カスタマイズ
- 設定ファイル `~/.config/nexusshell/ui.toml`。  
- キーバインドは `keymap.toml` でユーザ定義 (例: `"C-S" = "split-pane-horizontal"`).  
- プロンプトは `prompt.lua` または JSON スキーマ。  
- テーマは JSON: `{ "bg": "#282828", "fg": "#ebdbb2", ... }`。

---

## 10. 実装指針 (ratatui / crossterm)
1. **レイヤード描画**: Output → Status → Sidebar → Toast → Cursor の Z-index 固定。  
2. **非同期レンダ**: `tokio::select!` で入力と更新をマルチプレクス。  
3. **ダブルバッファ**: バーチャルバッファ差分のみ描画 → 画面フリッカゼロ。  
4. **Terminal Resize**: `SIGWINCH` 受信でコンポーネント幅再計算、ステート保持。  
5. **UTF-8 幅計算**: `unicode-width` クレートでマルチバイト対応。

---

## 11. 付録: モックアップ & ANSI アート
- `assets/mockups/` に PNG と ANSI アートを格納予定。  
- テーブルサンプル、Git パネル、補完パネルなど計 8 画面を用意する。

---

> **完了**: 本デザイン仕様は NexusShell UI 実装の唯一の参照ドキュメントであり、ここに記載された要件は CI で自動検証 (スクリーンショット比較・アクセシビリティテスト) される。 