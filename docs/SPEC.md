# NexusShell — 世界最高峰シェル環境 仕様書

> **本ドキュメントは NexusShell の設計・実装・テスト・運用まですべてを包括的に定義する正式仕様である。いかなる簡略化も許容しない。**

---

## 目次
1. 目的とビジョン  
2. 設計原則  
3. アーキテクチャ概要  
4. コア機能詳細  
5. UI / UX デザイン指針  
6. セキュリティモデル  
7. 国際化 (i18n) / ローカライズ (l10n)  
8. パフォーマンス要件 & ベンチマーク  
9. テスト戦略  
10. ビルド・配布・CI/CD  
11. 開発規約  
12. 将来的拡張ロードマップ  

---

## 1. 目的とビジョン

NexusShell は *既存すべてのシェルを凌駕* する次世代 CLI 環境である。

- **100% Rust 実装**: メモリ安全・高並列性能・高速コンパイル・クロスプラットフォームを両立。
- **完全 POSIX 互換 + 拡張オブジェクトパイプライン**: Bash の文字列パイプと PowerShell の構造化オブジェクトパイプを同時サポート。
- **統合 UX**: Z-shell の快適補完、Fish のインスタントフィードバック、PowerShell のリッチ構文、BusyBox の軽量性を一体化。
- **プラグインファースト設計**: WASI と Rust クレートでシームレスに機能拡張。
- **美と機能の融合**: 視認性・操作性・カスタマイズ性を高次元で両立し、TUI でありながら GUI に匹敵する体験を提供。

---

## 2. 設計原則

| # | 原則 | 説明 |
|---|------|------|
| 1 | **安全第一** | `unsafe` を最小限に抑え、Formal Verification 可能なコードを目指す。 |
| 2 | **互換と革新の両立** | POSIX 100% 互換をベースに、オブジェクトパイプや型付き変数など革新機能を追加。 |
| 3 | **モジュール化** | すべてをクレート単位で分割。ABI 安定性を保った上でホットスワップ。 |
| 4 | **性能最優先** | 起動 < 5 ms、補完レイテンシ < 1 ms、スクリプト実行速度 Bash 比 10×。 |
| 5 | **開発者体験** | コードベースは `cargo fmt`, `clippy`, `rust-analyzer` 完全対応。完全自動ドキュメント生成。 |
| 6 | **ユビキタスアクセス** | x86-64, AArch64, RISC-V64, WebAssembly, bare-metal 環境で同一バイナリ動作。 |
| 7 | **プライバシー保護** | テレメトリ完全 opt-in。ログは暗号化済みでユーザ制御下に保存。 |

---

## 3. アーキテクチャ概要

```mermaid
graph TD
  A[CLI フロントエンド] --> B{入力解析}
  B --> C[トークナイザ]
  C --> D[パーサ (PEG-based)]
  D --> E[AST 最適化]
  E --> F[実行エンジン]
  F --> |外部コマンド| G[プロセスランタイム]
  F --> |内部組込| H[Built-ins]
  F --> |オブジェクトパイプ| I[型付きパイプライン]
  G --> J[OS 抽象層]
  H --> J
  I --> H
  I --> G
  J --> K[Syscall Adapter (Rust)]
  K --> L[クロスプラットフォーム HAL]
  F --> M[ジョブスケジューラ]
  F --> N[エラーハンドラ]
  M --> O[コルーチン / async  実行]
  subgraph Plugin
    P[WASI Runtime] --> Q[WASM プラグイン]
  end
  F --> P
```

### 3.1 コンポーネント詳細

| コンポーネント | 主な責務 | 技術要素 |
|---------------|-----------|-----------|
| トークナイザ | UTF-8 ストリームを Token 列へ変換 | `logos` クレート |
| パーサ | PEG に基づく文法解析で AST 構築 | `pest` クレート |
| AST 最適化 | 定数畳み込み・無駄パイプ除去・代入展開 | 自前パス + MIR 風中間表現 |
| 実行エンジン | AST を逐次 or JIT 実行 | `cranelift` オプション JIT |
| 型付きパイプライン | `serde_json::Value` + カスタムトレイトで動的型付け | `serde`, `typetag` |
| ジョブスケジューラ | 非同期 / 並列実行管理 | `tokio` + work-stealing executor |
| OS 抽象層 | Syscall, Filesystem, Signals を統一 API で提供 | `nix`, `winapi` + 独自 HAL |
| WASI Runtime | Plugin をメモリサンドボックス内で実行 | `wasmtime` |

---

## 4. コア機能詳細

### 4.1 コマンド互換性 ✅ **実装状況の更新**

- **POSIX / GNU Coreutils**: 実装済みコマンドは現行で 158 個。`ls`, `grep`, `awk`, `sed`, `ps`, `cp`, `mv`, `find` など主要コマンドをカバー。残りは段階的に実装する。
- **Bash 拡張 (完全実装済み)**: 
  - パイプライン・リダイレクト全種類 (`|`, `|>`, `>`, `>>`, `<`, `2>`, `&>`)
  - 変数展開 (`$VAR`, `${VAR}`) 完全対応
  - コマンド置換 (`$(cmd)`, `` `cmd` ``) 新旧両形式
  - プロセス置換 (`<()`, `>()`) 実装済み
  - 算術展開 (`$((expr))`, `$[expr]`) 完全対応
  - パス展開・グロブ (`*`, `?`, `[...]`) 完全実装
- **PowerShell 互換 (一部実装済み)**: エイリアスは `--enable-ps-aliases`（環境 `NXSH_ENABLE_PS_ALIASES`/`NXSH_DISABLE_PS_ALIASES`）で有効化。互換モード（環境 `NXSH_PWSH_MODE=1`）における簡易オブジェクトパイプ互換は実験的段階（機能ゲート下）。
- **BusyBox モード (実装済み)**: `nxsh --busybox`/環境 `NXSH_BUSYBOX=1`/起動名がビルトイン名のいずれかで軽量単一バイナリ起動。機能ゲートで依存を削減し、最小構成は UI 無効・内蔵コマンド直ディスパッチ。`nxsh_cli` の `busybox-min`/`busybox-max` 構成を用意。
- **Z-shell 特化機能 (初期サブセット実装済み)**: グロブ修飾子・ブレース展開を実行エンジンへ統合。拡張グロブ否定 `!(pattern)` に対応。巨大展開時は環境 `NXSH_BRACE_EXPANSION_TRUNCATED=1` を設定する。

### 4.2 スクリプト言語拡張 📋 **実装中**

| 機能 | 例 | 実装状況 | 説明 |
|------|----|-----------| ------|
| パターンマッチ | `match $var { 1 => echo one, _ => echo other }` | 🔧 AST実装済み | Rust ライク構文、実行エンジン統合中 |
| 名前空間 | `use net::*` | 📋 計画中 | クレート風インポートシステム |
| クロージャ | `map { |x| $x * 2 }` | 📋 計画中 | 高階関数サポート |
| ジェネリクス | `fn push<T>(list: mut [T], item: T)` | 📋 計画中 | 型安全 API |
| エラーハンドリング | `try { cmd } catch { |e| warn $e }` | 🔧 部分実装 | Result 型ベース、構文拡張中 |
| マクロ | `macro_rules! upper { ($x:expr) => { echo $x \| tr a-z A-Z } }` | 📋 計画中 | コンパイル時展開 |

### 4.3 オブジェクトパイプライン 📋 **実装中**

- **型付きストリーム基盤**: バイト列/テキスト/JSON/オブジェクトの動的型判定を実装。
- **パイプ演算子**:
  - `|>`（by-value）/ `||>`（by-reference 並列）は文法・AST で定義済み。実行レイヤでは互換モード下での実験実装を提供し、並列度やバックプレッシャの調整は今後強化する。
  - `|` は従来のバイトストリームパイプとして完全実装。
- **データ指向コマンド**: `select`, `where`, `sort-by`, `group-by` は段階的に拡充中。

### 4.4 インタラクティブ体験 🔧 **TUI→CUI移行中**

- **リアルタイム構文解析**: 入力中のカラーリング・エラー表示 ✅ 実装済み
- **インテリセンス補完**: 型・オプション情報からの候補推論 ✅ 実装済み  
- **ドキュメントポップアップ**: `F1` キーでのコマンド詳細表示（CUI ではヘルプテキストを標準出力へ挿入）。
- **セッション録画/再生**: `rec start/stop/play` コマンドを実装。入力/出力を JSON Lines で記録し、相対タイムスタンプに基づく再生と速度変更をサポート。
- **プロンプト機能**: Git情報・システム情報統合表示 ✅ 実装済み

### 4.5 プラグインシステム ✅ **実装済み**

| 形式 | 言語サポート | 隔離方式 | 実装状況 | 例 |
|------|-------------|----------|----------|-----|
| Native Crate | Rust | 同一プロセス/Capability制限 | ✅ 完全実装 | `cargo nxsh-plugin new foo` |
| WASM | Rust/C/Zig/AssemblyScript | WASI Sandbox | ✅ wasmtime統合済み | `module load foo.wasm` |
| External Binary | 任意言語 | fork-exec | ✅ 実装済み | `foo.sh`, `foo.exe`, `foo.py` |

**追加機能**:
- **Capabilities Manifest** (`cap.toml`) による権限制御 ✅
- **Semantic Versioning** + 依存解決システム ✅  
- **ホットスワップ対応** - 実行中プラグイン更新 ✅
- **リソース管理** - メモリ制限・タイムアウト・GC ✅

- すべてのプラグインに **Capabilities Manifest** (`cap.toml`) を必須化。
- Semantic Versioning, 依存解決は `cargo-companion` で自動管理。

### 4.6 ランタイム制御 ✅

- **実行タイムアウト**: グローバル（環境 `NXSH_TIMEOUT_MS`）とコマンド個別（環境 `NXSH_CMD_TIMEOUT_MS`）を実装。グローバル期限に達した場合は即時中断し、終了コード 124 を返す。個別タイムアウトは外部プロセス待機に適用し、期限超過時に安全に kill して終了コード 124 を返す。優先順位はグローバルが上位。
- **実行時間計測**: 各コマンドの実行時間をマイクロ秒精度で収集し、内部メトリクスへ反映。

### 4.7 アップデータ ✅（機能ゲート）

- **HTTP クライアント**: 軽量な `ureq` を採用。
- **整合性検証**: SHA‑256 チェックサムは常に実行。Ed25519 署名検証は `crypto-ed25519` 有効時に実施（公開鍵は検証キーセットにより管理）。
- **差分適用**: フル/デルタの更新モードを設計し、履歴・進捗・ロールバックをサポート。

### 4.8 ロギング / メトリクス ✅（構成に応じて有効）

- **CombinedWriter** によりコンソール/ファイル出力と統計収集を統合。書込エラー回数などのメトリクスを保持。
- `logstats` ビルトインを提供。`--json` / `--pretty` でメトリクスをダンプ。ロギング機能無効の構成ではスタブ出力で整形 JSON を返す。

---

## 5. UI / UX デザイン指針

### 5.1 テーマ

- JSON/YAML ベースで色・フォント・アイコンセットを定義。
- ダーク・ライト・高コントラスト・企業ブランド色など公式 20 テーマを提供。

### 5.2 レイアウト

```
┌───────────────────────────────────────────────────┐
│ user@host ~/workspace  14:32  [git:main ✗]       │ ← ステータスライン
├───────────────────────────────────────────────────┤
│ λ cargo build --release                           │ ← 入力ライン
│ │                                               │
│ ▼                                               │
│ … コマンド出力 …                               │
└───────────────────────────────────────────────────┘
```

- ステータスラインはジョブ数・CPU/メモリ・ネットワーク・バッテリ状況をアイコンで可視化。
- 出力ペインの自動折返しとスクロールバー、`Alt+↑ / Alt+↓` で独立スクロール。

### 5.3 アクセシビリティ

- 色覚多様性対応: 選択範囲を形状でも示す。
- スクリーンリーダー: ANSI 制御文字を ARIA 注釈へ変換して読み上げ。

---

## 6. セキュリティモデル

| レイヤ | 機構 | 詳細 |
|--------|------|------|
| シェルランタイム | Capability Sandbox | `fs_read`, `net_bind`, `proc_kill` 等を最小権限付与 |
| プラグイン | 署名検証 | Ed25519 + TUF メタデータでサプライチェーン保護 |
| ヒストリ | 暗号化 | Argon2id 派生鍵 + AES-GCM 256-bit |
| ネットワーク | mTLS | クライアント証明書必須の P2P モード |
| コンフィグ | Policy DSL | Yaml/Json/Toml で Allow/Deny ルール宣言 |

- **ゼロトラスト設計**: すべての外部 I/O 要求はポリシーエンジンを経由。
- **再現性ビルド**: `--locked` フラグで deterministic output を保証。

---

## 7. 国際化 / ローカライズ

- 翻訳は `gettext` 互換 `.po` / `.mo`、メッセージカタログ自動抽出。
- 日付・数値・ファイルサイズは `unic-langid` で Locale 準拠フォーマット。
- コマンド別エイリアス: `コピー`, `移动`, `копировать` → `cp` が動作例。

---

## 8. パフォーマンス要件 & ベンチマーク

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| 起動時間 | ≤ 5 ms | `hyperfine` 10,000 回平均 |
| メモリ常駐 | ≤ 15 MiB | `smem` RSS |
| ls ‑R `/usr` | Bash 比 10× 速 | ファイル数 60k で計測 |
| grep ‑r `TODO` | ripgrep 同等 | 1 GiB ソースツリー |
| 補完レイテンシ | < 1 ms | 平均応答時間 |

ベンチ対象環境: x86-64 3.6 GHz 8C16T, 32 GiB RAM, NVMe SSD。

---

## 9. テスト戦略

1. **単体テスト**: 各クレートに `#[cfg(test)]` 1,500+ ケース。
2. **統合テスト**: POSIX PCTS + GNU BATS + PowerShell Pester スイート。
3. **プロトコルコンプライアンス**: シグナル/TTY/PTY 相互作用を擬似端末で検証。
4. **Fuzzing**: `cargo-fuzz` + libFuzzer による連続 48 h ラン。
5. **静的解析**: `cargo clippy --all --deny warnings`、`cargo-audit`、`crev`。
6. **コードカバレッジ**: `grcov` で 95% 以上を維持。

---

## 10. ビルド・配布・CI/CD

- **ビルドシステム**: `cargo` ワークスペース + `justfile` タスクランナー。
- **クロスコンパイル**: `cross` で Linux/Windows/macOS/FreeBSD を一括ビルド。
- **パッケージング**: `.nspkg`, Homebrew Formulae, Debian `.deb`, Arch `.pkg.tar.zst`, Scoop Manifest。
- **CI/CD**: GitHub Actions で 30 並列ジョブ、Release Drafter + Cosign 署名。
- **Docker**: `ghcr.io/seleniashell/nxsh:latest` ベースイメージ提供 (alpine, debian-slim)。

---

## 11. 開発規約

- `main` ブランチは常に green。Feature は PR + Review 2 名必須。
- コーディング規約は Rustfmt default + `#![deny(clippy::all)]`。
- コミットメッセージは Conventional Commits。`feat:`, `fix:`, `perf:` など。
- ドキュメント未整備のコードはマージ不可。

---

## 12. 将来的拡張ロードマップ

| フェーズ | 概要 | 優先度 |
|----------|------|---------|
| A | GPU パイプラインアクセラレーション | ★★★★★ |
| B | 分散シェル (クラスタリング) | ★★★★☆ |
| C | 組込 GUI ターミナル (Wayland/Win32) | ★★★★☆ |
| D | AI 補完 *非推論* モード※ | ★★★☆☆ |
| E | 音声入出力インタフェース | ★★★☆☆ |

※ *AI という用語を使用せず、外部推論エンジンを一切組み込まない補完方式を指す。*

---

> この仕様は NexusShell コアチームにより厳密に管理され、実装・テスト・リリースのすべての段階で遵守される。違反 PR は自動リジェクトされる。 